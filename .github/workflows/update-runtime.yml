name: Update HSX Runtime Package

on:
  push:
    paths:
      - 'frontend/hsx-runtime.js'
      - 'backend/hsx-compiler.js'

jobs:
  build-runtime:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Create runtime folder
        run: mkdir -p runtime

      - name: Copy latest core files
        run: |
          cp frontend/hsx-runtime.js runtime/
          cp backend/hsx-compiler.js runtime/

      - name: Generate dynamic README
        run: |
          FRONTEND_CHANGED=""
          BACKEND_CHANGED=""

          if git diff --name-only HEAD~1 | grep -q "frontend/hsx-runtime.js"; then
            FRONTEND_CHANGED="- Updated frontend runtime (hsx-runtime.js)"
          fi

          if git diff --name-only HEAD~1 | grep -q "backend/hsx-compiler.js"; then
            BACKEND_CHANGED="- Updated backend compiler (hsx-compiler.js)"
          fi

          {
            echo "# HSX Runtime Package"
            echo
            echo "This folder is auto-generated by GitHub Actions."
            echo
            echo "## Contents"
            echo "- hsx-runtime.js  → Frontend execution engine"
            echo "- hsx-compiler.js → Backend compiler engine"
            echo
            echo "## Purpose"
            echo "This package represents the current official HSX runtime snapshot."
            echo
            echo "## Recent Changes"
            echo "$FRONTEND_CHANGED"
            echo "$BACKEND_CHANGED"
          } > runtime/README.md

      - name: Generate dynamic Evolution Diagram
        run: |
          IMPROVEMENTS=""

          if git diff --name-only HEAD~1 | grep -q "frontend/hsx-runtime.js"; then
            IMPROVEMENTS="${IMPROVEMENTS}Frontend runtime: improved execution, DOM handling, stability\n"
          fi

          if git diff --name-only HEAD~1 | grep -q "backend/hsx-compiler.js"; then
            IMPROVEMENTS="${IMPROVEMENTS}Backend compiler: parsing, modules, validation improvements\n"
          fi

          {
            echo "HSX CORE EVOLUTION SNAPSHOT"
            echo
            echo "Frontend Runtime:"
            echo "[hsx-runtime.js]  -->  UI | DOM | Emotions | Fun | Meta | Interpreter"
            echo
            echo "Backend Compiler:"
            echo "[hsx-compiler.js] -->  Parsing | Modules | Grammar | Validation"
            echo
            echo "Improvement Summary:"
            printf "$IMPROVEMENTS"
          } > runtime/EVOLUTION-DIAGRAM.txt

      - name: Commit runtime snapshot with dynamic message
        run: |
          git config user.name "hsx-bot"
          git config user.email "hsx-bot@users.noreply.github.com"

          git add runtime frontend/hsx-runtime.js backend/hsx-compiler.js

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          MSG="Auto-update HSX runtime snapshot:"

          if git diff --cached --name-only | grep -q "frontend/hsx-runtime.js"; then
            MSG="${MSG}\n- Updated frontend runtime (hsx-runtime.js)"
          fi

          if git diff --cached --name-only | grep -q "backend/hsx-compiler.js"; then
            MSG="${MSG}\n- Updated backend compiler (hsx-compiler.js)"
          fi

          git commit -m "$(printf "$MSG")"
          git push
