name: Update HSX Runtime Package

on:
  push:
    paths:
      - 'frontend/hsx-runtime.js'
      - 'backend/hsx-compiler.js'

jobs:
  build-runtime:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Ensure full history for diffs

      - name: Create runtime folder
        run: mkdir -p runtime

      - name: Copy latest core files
        run: |
          cp frontend/hsx-runtime.js runtime/
          cp backend/hsx-compiler.js runtime/

      - name: Generate dynamic README
        run: |
          # Detect changes
          FRONTEND_CHANGED=""
          BACKEND_CHANGED=""
          if git diff --cached --name-only | grep -q "frontend/hsx-runtime.js"; then
            FRONTEND_CHANGED="- Updated frontend runtime (hsx-runtime.js)"
          fi
          if git diff --cached --name-only | grep -q "backend/hsx-compiler.js"; then
            BACKEND_CHANGED="- Updated backend compiler (hsx-compiler.js)"
          fi
          CHANGES="$FRONTEND_CHANGED"$'\n'"$BACKEND_CHANGED"

          # Generate README.md
          cat << EOF > runtime/README.md
          # HSX Runtime Package

          This folder is auto-generated by GitHub Actions.

          ## Contents
          - hsx-runtime.js  → Frontend execution engine
          - hsx-compiler.js → Backend compiler engine

          ## Purpose
          This package represents the current official HSX runtime snapshot.

          ## Recent Changes
          $CHANGES
          EOF

      - name: Generate dynamic Evolution Diagram
        run: |
          IMPROVEMENTS=""
          if git diff --cached --name-only | grep -q "frontend/hsx-runtime.js"; then
            IMPROVEMENTS+="Frontend runtime: improved execution, DOM handling, stability\n"
          fi
          if git diff --cached --name-only | grep -q "backend/hsx-compiler.js"; then
            IMPROVEMENTS+="Backend compiler: parsing, modules, validation improvements\n"
          fi

          cat << EOF > runtime/EVOLUTION-DIAGRAM.txt
          HSX CORE EVOLUTION SNAPSHOT

          Frontend Runtime:
          [hsx-runtime.js]  -->  UI | DOM | Emotions | Fun | Meta | Interpreter

          Backend Compiler:
          [hsx-compiler.js] -->  Parsing | Modules | Grammar | Validation

          Improvement Summary:
          $IMPROVEMENTS
          EOF

      - name: Commit runtime snapshot with dynamic message
        run: |
          git config user.name "hsx-bot"
          git config user.email "hsx-bot@users.noreply.github.com"
          
          # Stage changes
          git add runtime frontend/hsx-runtime.js backend/hsx-compiler.js
          
          # Generate a dynamic commit message
          MSG="Auto-update HSX runtime snapshot:\n"
          if git diff --cached --name-only | grep -q "frontend/hsx-runtime.js"; then
            MSG="$MSG- Updated frontend runtime (hsx-runtime.js)\n"
          fi
          if git diff --cached --name-only | grep -q "backend/hsx-compiler.js"; then
            MSG="$MSG- Updated backend compiler (hsx-compiler.js)\n"
          fi
          
          # Commit only if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "$MSG"
            git push
          else
            echo "No changes to commit."
